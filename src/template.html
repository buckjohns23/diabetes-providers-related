<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Diabetes Providers Related</title>

  <!-- Free Excel export library -->
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --line:#e2e8f0;
      --primary:#2563eb;
      --primary2:#0ea5e9;
      --shadow: 0 10px 24px rgba(2, 6, 23, .08);
      --radius:16px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #f8fafc, var(--bg));
      color:var(--text);
    }
    .wrap{max-width:1150px; margin:0 auto; padding:18px 14px 60px;}
    .header{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    h1{margin:0; font-size:20px;}
    .sub{margin-top:6px; color:var(--muted); font-size:13px; line-height:1.4;}

    .controls{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1.4fr 220px 220px 220px;
      gap:10px;
      align-items:end;
    }
    .field label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px 4px;
    }
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      font-size:14px;
      outline:none;
    }
    input::placeholder{color:#94a3b8;}

    .btnRow{
      margin-top:12px;
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:center; justify-content:space-between;
    }
    .btns{display:flex; gap:10px; flex-wrap:wrap;}
    .btn{
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-size:13px;
      cursor:pointer;
      box-shadow: 0 2px 10px rgba(2,6,23,.06);
    }
    .btn.primary{
      background: linear-gradient(90deg, var(--primary), var(--primary2));
      color:#fff;
      border-color: transparent;
    }
    .btn:active{transform: translateY(1px);}

    .meta{color:var(--muted); font-size:12px; line-height:1.4;}
    .count{font-weight:800; color:var(--text);}

    /* Desktop table */
    .tableWrap{
      margin-top:14px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    table{width:100%; border-collapse:separate; border-spacing:0;}
    thead th{
      text-align:left;
      font-size:12px;
      color:#475569;
      background:#f8fafc;
      border-bottom:1px solid var(--line);
      padding:12px;
      position:sticky;
      top:0;
      z-index:1;
    }
    tbody td{
      border-bottom:1px solid #f1f5f9;
      padding:12px;
      vertical-align:top;
      font-size:13px;
    }
    tbody tr:hover td{background:#fafafa;}
    .name{font-weight:900; font-size:14px;}
    .muted{color:var(--muted); font-size:12px; line-height:1.35;}
    .tag{display:inline-block; margin-left:8px; font-size:11px; padding:3px 8px; border:1px solid var(--line); border-radius:999px; color:#334155; background:#fff;}
    .actionsCell{white-space:nowrap;}
    .aBtn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:9px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      font-size:12px;
      cursor:pointer;
      text-decoration:none;
      margin-right:8px;
    }
    .aBtn.call{border-color:#bbf7d0; background:#f0fdf4; color:#166534;}
    .aBtn.maps{border-color:#bfdbfe; background:#eff6ff; color:#1d4ed8;}

    /* Mobile cards */
    .cards{display:none; margin-top:14px; gap:12px;}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .cardTop{display:flex; justify-content:space-between; gap:12px; align-items:flex-start;}
    .cardName{font-weight:900;}
    .cardActions{margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;}
    .cardLine{margin-top:8px; color:var(--muted); font-size:12px; line-height:1.35;}

    @media (max-width: 980px){
      .controls{grid-template-columns: 1fr 1fr;}
    }
    @media (max-width: 720px){
      .controls{grid-template-columns: 1fr;}
      .tableWrap{display:none;}
      .cards{display:grid;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>Diabetes Providers Related</h1>
      <div class="sub" id="sub"></div>

      <div class="controls">
        <div class="field">
          <label for="q">Search</label>
          <input id="q" placeholder="Name, clinic, city, phone, ZIP, NPI (optional)" />
        </div>

        <div class="field">
          <label for="specialty">Specialty</label>
          <select id="specialty">
            <option value="">All</option>
            <option value="endocrinology">Endocrinology</option>
            <option value="pediatric">Pediatric Endocrinology</option>
            <option value="family">Family Medicine</option>
            <option value="internal">Internal Medicine</option>
            <option value="nurse">Nurse Practitioner</option>
            <option value="assistant">Physician Assistant</option>
          </select>
        </div>

        <div class="field">
          <label for="city">City</label>
          <select id="city">
            <option value="">All</option>
          </select>
        </div>

        <div class="field">
          <label for="sort">Sort by</label>
          <select id="sort">
            <option value="endo_city_name">Endocrinology first</option>
            <option value="name">Name A–Z</option>
            <option value="city">City A–Z</option>
            <option value="years">Most years (proxy)</option>
          </select>
        </div>
      </div>

      <div class="btnRow">
        <div class="meta">
          <span class="count" id="count"></span><br/>
          <span id="updated"></span>
        </div>
        <div class="btns">
          <button class="btn" id="btnReset">Reset</button>
          <button class="btn" id="btnCsv">Export CSV</button>
          <button class="btn primary" id="btnXlsx">Export Excel</button>
        </div>
      </div>
    </div>

    <!-- Desktop -->
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="width:22%;">Provider</th>
            <th style="width:18%;">Clinic / Organization</th>
            <th style="width:20%;">Specialty</th>
            <th style="width:12%;">Phone</th>
            <th style="width:22%;">Address</th>
            <th style="width:6%;">Actions</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <!-- Mobile -->
    <div class="cards" id="cards"></div>
  </div>

<script>
/*__EMBEDDED_DATA__*/

const data = DIRECTORY_DATA;
const providers = (data.providers || []).slice();

document.getElementById("sub").textContent =
  `Updated weekly. Includes clinic/org and credentials when available from NPI.`;

document.getElementById("updated").textContent =
  `Last updated: ${data.generated_utc} UTC`;

const qEl = document.getElementById("q");
const sEl = document.getElementById("specialty");
const cityEl = document.getElementById("city");
const sortEl = document.getElementById("sort");
const rowsEl = document.getElementById("rows");
const cardsEl = document.getElementById("cards");
const countEl = document.getElementById("count");

function normalize(str){ return (str || "").toString().toLowerCase(); }

function specialtyMatch(p, sel){
  if(!sel) return true;
  const t = normalize(p.taxonomy);
  if(sel === "endocrinology") return t.includes("endocrinology") && !t.includes("pediatric");
  if(sel === "pediatric") return t.includes("pediatric") && t.includes("endocrinology");
  if(sel === "family") return t.includes("family medicine");
  if(sel === "internal") return t.includes("internal medicine");
  if(sel === "nurse") return t.includes("nurse practitioner");
  if(sel === "assistant") return t.includes("physician assistant");
  return true;
}

function mapsUrl(p){
  const q = encodeURIComponent(`${p.address}, ${p.city}, ${p.state} ${p.zip}`);
  return `https://www.google.com/maps/search/?api=1&query=${q}`;
}
function telHref(p){
  if(!p.phone) return "";
  const digits = (p.phone+"").replace(/\D+/g,"");
  return digits ? `tel:${digits}` : "";
}

function fillCityDropdown(){
  const cities = [...new Set(providers.map(p => (p.city || "").trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  for(const c of cities){
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    cityEl.appendChild(opt);
  }
}
fillCityDropdown();

function sortList(list, mode){
  const copy = [...list];
  if(mode === "endo_city_name"){
    copy.sort((a,b)=>{
      const ae = normalize(a.taxonomy).includes("endocrinology") ? 0 : 1;
      const be = normalize(b.taxonomy).includes("endocrinology") ? 0 : 1;
      if(ae !== be) return ae - be;
      const ac = (a.city||"").localeCompare(b.city||"");
      if(ac !== 0) return ac;
      return (a.name||"").localeCompare(b.name||"");
    });
  }
  if(mode === "name"){
    copy.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
  }
  if(mode === "city"){
    copy.sort((a,b)=>{
      const ac = (a.city||"").localeCompare(b.city||"");
      if(ac !== 0) return ac;
      return (a.name||"").localeCompare(b.name||"");
    });
  }
  if(mode === "years"){
    copy.sort((a,b)=> (b.years_in_practice_proxy||0) - (a.years_in_practice_proxy||0));
  }
  return copy;
}

function getFiltered(){
  const q = normalize(qEl.value);
  const sel = sEl.value;
  const city = cityEl.value;

  let list = providers.filter(p=>{
    if(!specialtyMatch(p, sel)) return false;
    if(city && (p.city||"") !== city) return false;

    if(!q) return true;
    const blob = normalize([
      p.name, p.clinic, p.credential, p.phone, p.city, p.zip, p.address, p.taxonomy, p.npi
    ].join(" "));
    return blob.includes(q);
  });

  return sortList(list, sortEl.value);
}

function render(){
  const list = getFiltered();
  countEl.textContent = `Showing ${list.length} of ${providers.length} providers`;

  rowsEl.innerHTML = list.map(p=>{
    const phone = p.phone ? `<a href="${telHref(p)}">${p.phone}</a>` : `<span class="muted">Not listed</span>`;
    const callBtn = p.phone ? `<a class="aBtn call" href="${telHref(p)}">Call</a>` : ``;

    const providerLine = `
      <div class="name">${p.name || ""}<span class="tag">${p.provider_type || ""}</span></div>
      <div class="muted">NPI: ${p.npi || ""}</div>
    `;

    const clinic = p.clinic ? `<div>${p.clinic}</div>` : `<span class="muted">—</span>`;
    const spec = p.taxonomy ? `<div>${p.taxonomy}</div>` : `<span class="muted">—</span>`;

    return `
      <tr>
        <td>${providerLine}</td>
        <td>${clinic}</td>
        <td>${spec}</td>
        <td>${phone}</td>
        <td>
          <div>${p.address || ""}</div>
          <div class="muted">${p.city || ""}, ${p.state || ""} ${p.zip || ""}</div>
        </td>
        <td class="actionsCell">
          ${callBtn}
          <a class="aBtn maps" href="${mapsUrl(p)}" target="_blank" rel="noopener">Maps</a>
        </td>
      </tr>
    `;
  }).join("");

  cardsEl.innerHTML = list.map(p=>{
    const call = p.phone ? `<a class="aBtn call" href="${telHref(p)}">Call</a>` : `<span class="muted">Phone not listed</span>`;
    return `
      <div class="card">
        <div class="cardTop">
          <div>
            <div class="cardName">${p.name || ""}</div>
            <div class="cardLine">${p.clinic ? p.clinic : ""}</div>
            <div class="cardLine">${p.taxonomy || ""}</div>
          </div>
        </div>
        <div class="cardLine">${p.address || ""}, ${p.city || ""}, ${p.state || ""} ${p.zip || ""}</div>
        <div class="cardLine">NPI: ${p.npi || ""}</div>
        <div class="cardActions">
          ${call}
          <a class="aBtn maps" href="${mapsUrl(p)}" target="_blank" rel="noopener">Maps</a>
        </div>
      </div>
    `;
  }).join("");
}

[qEl, sEl, cityEl, sortEl].forEach(el => el.addEventListener("input", render));
render();

document.getElementById("btnReset").addEventListener("click", ()=>{
  qEl.value = "";
  sEl.value = "";
  cityEl.value = "";
  sortEl.value = "endo_city_name";
  render();
});

/* EXPORTS: exports the CURRENT filtered list */
function exportRows(){
  const list = getFiltered();
  return list.map(p => ({
    NPI: p.npi || "",
    Name: p.name || "",
    Credential: p.credential || "",
    ProviderType: p.provider_type || "",
    ClinicOrOrganization: p.clinic || "",
    Specialty: p.taxonomy || "",
    Phone: p.phone || "",
    Address: p.address || "",
    City: p.city || "",
    State: p.state || "",
    ZIP: p.zip || "",
    NPI_Enumerated: p.enumeration_date || "",
    YearsProxy: p.years_in_practice_proxy || "",
  }));
}

function downloadBlob(filename, blob){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
}

document.getElementById("btnCsv").addEventListener("click", () => {
  const rows = exportRows();
  const headers = Object.keys(rows[0] || {NPI:""});
  const esc = (v) => {
    const s = (v ?? "").toString();
    const needs = /[",\n]/.test(s);
    const out = s.replace(/"/g,'""');
    return needs ? `"${out}"` : out;
  };
  const csv = [
    headers.join(","),
    ...rows.map(r => headers.map(h => esc(r[h])).join(","))
  ].join("\n");

  const stamp = (data.generated_utc || "").replace(/[: ]/g,"-");
  downloadBlob(`diabetes-providers-related_${stamp}.csv`, new Blob([csv], {type:"text/csv;charset=utf-8;"}));
});

document.getElementById("btnXlsx").addEventListener("click", () => {
  const rows = exportRows();
  if(!window.XLSX){
    alert("Excel export is still loading. Try again in a second.");
    return;
  }
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Providers");
  const stamp = (data.generated_utc || "").replace(/[: ]/g,"-");
  XLSX.writeFile(wb, `diabetes-providers-related_${stamp}.xlsx`);
});
</script>
</body>
</html>
